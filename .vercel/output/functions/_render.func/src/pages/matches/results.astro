---
import Layout from "../../layouts/Layout.astro";
import TopBar from "../../features/layout/components/TopBar.astro";
import Header from "../../features/layout/components/Header.astro";
import MobileMenu from "../../features/layout/components/MobileMenu";
import Footer from "../../features/layout/components/Footer.astro";
import Spacing from "../../shared/components/ui/Spacing.astro";
import { getCompletedMatches } from "../../features/matches/lib/queries";
import MatchList from "../../features/matches/components/MatchList";
import PageLoader from "../../components/PageLoader";
import ContentLoader from "../../components/ContentLoader";
import type { MatchWithTeamsAndLeagueAndSeason } from "../../features/cms/types";

export const prerender = false;

// Fetch completed matches from database
let matches: MatchWithTeamsAndLeagueAndSeason[] = [];
let hasError = false;
try {
  matches = await getCompletedMatches();
} catch (error) {
  console.error('Error fetching match results:', error);
  hasError = true;
}
---

<Layout>
  <PageLoader client:load />
  <div id="wrapper">
    <TopBar />
    <Header />
    <MobileMenu client:load />
    <div id="main">
      <div
        class="stm-title-box-unit transparent-header_on title_box-357"
        style="padding-top: 0; padding-bottom: 0px;"
      ></div>
      <div class="container">
        <section class="wpb-content-wrapper">
          <div class="vc_row wpb_row vc_row-fluid">
            <div class="wpb_column vc_column_container vc_col-sm-12">
              <div class="vc_column-inner">
                <div class="wpb_wrapper">
                  <Spacing
                    id="stm-spacing-results-header"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />

                  <h2 class="heading-font" style="text-align: center; margin-bottom: 50px; color: #dd3333;">
                    MATCH RESULTS
                  </h2>

                  {hasError ? (
                    <ContentLoader client:load message="Failed to load match results. Please try again later." />
                  ) : (
                    <MatchList 
                    client:load 
                    matches={matches}
                    showFilters={true}
                    showLeague={true}
                    onMatchClick={(match) => {
                      window.location.href = `/matches/${match.id}`;
                    }}
                  />
                  )}

                  <Spacing
                    id="stm-spacing-results-footer"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <Footer />

  <div class="sp-footer-sponsors">
    <div class="sportspress"><div class="sp-sponsors"></div></div>
  </div>
</Layout>

<style is:inline type="text/css">
  .sp-footer-sponsors {
    background: #f4f4f4;
    color: #363f48;
  }
  .sp-footer-sponsors .sp-sponsors .sp-sponsors-title {
    color: #363f48;
  }

  .heading-font {
    font-size: 40px;
    line-height: 44px;
    margin-bottom: 50px;
    color: #dd3333 !important;
  }
</style>


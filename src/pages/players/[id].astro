---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import TopBar from '../../features/layout/components/TopBar.astro';
import Header from '../../features/layout/components/Header.astro';
import MobileMenu from '../../features/layout/components/MobileMenu';
import Footer from '../../features/layout/components/Footer.astro';
import { getPlayerById } from '../../features/cms/lib/queries';
import Spacing from '../../shared/components/ui/Spacing.astro';

const { id } = Astro.params;
if (!id) {
  return Astro.redirect('/404', 302);
}

let player;
try {
  player = await getPlayerById(id);
  if (!player) {
    return Astro.redirect('/404', 302);
  }
} catch (error) {
  console.error('Error fetching player:', error);
  return Astro.redirect('/404', 302);
}

// Format player name
const getPlayerName = (): string => {
  if (player.firstName && player.lastName) {
    return `${player.firstName} ${player.lastName}`;
  }
  return player.firstName || player.lastName || 'Unknown Player';
};

const playerName = getPlayerName();

// Format stats from JSON
const getStat = (stats: any, key: string): number => {
  if (!stats || typeof stats !== 'object') return 0;
  return stats[key] || 0;
};

// Format stat value
const formatStat = (value: number): string => {
  return value === 0 ? "-" : value.toFixed(1);
};

// Format percentage
const formatPercent = (value: number): string => {
  return value === 0 ? "-" : value.toFixed(1);
};

const stats = player.stats || {};

// SEO Meta Tags
const pageTitle = `${playerName} - Players - Elevate Ballers`;
const pageDescription = player.bio || `View ${playerName}'s profile, statistics, and information`;
const pageUrl = `${Astro.url.origin}/players/${id}`;
---

<Layout>
  <script is:inline define:vars={{ pageTitle, pageDescription, pageUrl }}>
    // Update page title
    document.title = pageTitle;
    
    // Update or create meta tags
    const updateMeta = (name, content, property = false) => {
      const attr = property ? 'property' : 'name';
      let meta = document.querySelector(`meta[${attr}="${name}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.setAttribute(attr, name);
        document.head.appendChild(meta);
      }
      meta.setAttribute('content', content);
    };
    
    // Update canonical link
    let canonical = document.querySelector('link[rel="canonical"]');
    if (!canonical) {
      canonical = document.createElement('link');
      canonical.setAttribute('rel', 'canonical');
      document.head.appendChild(canonical);
    }
    canonical.setAttribute('href', pageUrl);
    
    // Set meta tags
    updateMeta('og:locale', 'en_US', true);
    updateMeta('og:type', 'profile', true);
    updateMeta('og:title', pageTitle, true);
    updateMeta('og:description', pageDescription, true);
    updateMeta('og:url', pageUrl, true);
    updateMeta('og:site_name', 'Elevate Ballers', true);
    updateMeta('twitter:card', 'summary_large_image');
  </script>
  
  <script type="application/ld+json" is:inline set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebPage",
        "@id": pageUrl,
        "url": pageUrl,
        "name": pageTitle,
        "isPartOf": { "@id": `${Astro.url.origin}/#website` },
        "datePublished": "2016-04-19T05:29:11+00:00",
        "dateModified": new Date().toISOString(),
        "breadcrumb": { "@id": `${pageUrl}#breadcrumb` },
        "inLanguage": "en-US"
      },
      {
        "@type": "BreadcrumbList",
        "@id": `${pageUrl}#breadcrumb`,
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": `${Astro.url.origin}/` },
          { "@type": "ListItem", "position": 2, "name": "Players", "item": `${Astro.url.origin}/players` },
          { "@type": "ListItem", "position": 3, "name": playerName }
        ]
      }
    ]
  })} />
  
  <div id="wrapper">
    <TopBar />
    <Header />
    <MobileMenu client:load />
    <div id="main">
      <div
        class="stm-title-box-unit transparent-header_on title_box-357"
        style="padding-top: 0; padding-bottom: 0px;"
      ></div>
      <div class="container">
        <section class="wpb-content-wrapper">
          <div class="vc_row wpb_row vc_row-fluid">
            <div class="wpb_column vc_column_container vc_col-sm-12">
              <div class="vc_column-inner">
                <div class="wpb_wrapper">
                  <Spacing
                    id="stm-spacing-player-header"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />

                  <!-- Player Header -->
                  <div class="player-header">
                    <div class="player-header-content">
                      {player.image ? (
                        <div class="player-image-large">
                          <img 
                            src={player.image} 
                            alt={playerName}
                            loading="lazy"
                          />
                        </div>
                      ) : (
                        <div class="player-image-large-placeholder">
                          <span class="player-image-text-large">
                            {player.firstName?.charAt(0) || ''}{player.lastName?.charAt(0) || ''}
                          </span>
                        </div>
                      )}
                      <div class="player-header-info">
                        <h1 class="player-title">{playerName}</h1>
                        {player.team && (
                          <p class="player-team">
                            <a href={`/teams/${player.team.slug}`} class="team-link">
                              {player.team.name}
                            </a>
                          </p>
                        )}
                        <div class="player-details">
                          {player.position && (
                            <span class="player-detail-item">
                              <i class="fa fa-map-marker" aria-hidden="true"></i>
                              Position: <strong>{player.position}</strong>
                            </span>
                          )}
                          {player.jerseyNumber && (
                            <span class="player-detail-item">
                              <i class="fa fa-tag" aria-hidden="true"></i>
                              Jersey: <strong>#{player.jerseyNumber}</strong>
                            </span>
                          )}
                          {player.height && (
                            <span class="player-detail-item">
                              <i class="fa fa-arrows-v" aria-hidden="true"></i>
                              Height: <strong>{player.height}</strong>
                            </span>
                          )}
                          {player.weight && (
                            <span class="player-detail-item">
                              <i class="fa fa-balance-scale" aria-hidden="true"></i>
                              Weight: <strong>{player.weight}</strong>
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>

                  <Spacing
                    id="stm-spacing-player-content"
                    lg="40"
                    md="40"
                    sm="30"
                    xs="30"
                  />

                  <!-- Bio Section -->
                  {player.bio && (
                    <div class="player-section">
                      <h2 class="section-title">About</h2>
                      <div class="player-bio">
                        <p>{player.bio}</p>
                      </div>
                    </div>
                  )}

                  <Spacing
                    id="stm-spacing-player-stats"
                    lg="40"
                    md="40"
                    sm="30"
                    xs="30"
                  />

                  <!-- Statistics Section -->
                  {Object.keys(stats).length > 0 && (
                    <div class="player-section">
                      <h2 class="section-title">Statistics</h2>
                      <div class="player-stats-grid">
                        <div class="stat-card">
                          <div class="stat-label">Field Goal %</div>
                          <div class="stat-value">{formatPercent(getStat(stats, 'fgPercent') || getStat(stats, 'fg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Free Throw %</div>
                          <div class="stat-value">{formatPercent(getStat(stats, 'ftPercent') || getStat(stats, 'ft'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">3-Point %</div>
                          <div class="stat-value">{formatPercent(getStat(stats, 'threePointPercent') || getStat(stats, '3p'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Rebounds Per Game</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'rpg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Assists Per Game</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'apg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Steals Per Game</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'spg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Blocks Per Game</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'bpg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Points Per Game</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'ppg'))}</div>
                        </div>
                        <div class="stat-card">
                          <div class="stat-label">Efficiency</div>
                          <div class="stat-value">{formatStat(getStat(stats, 'eff'))}</div>
                        </div>
                      </div>
                    </div>
                  )}

                  {Object.keys(stats).length === 0 && (
                    <div class="player-section">
                      <h2 class="section-title">Statistics</h2>
                      <p class="no-data-message">No statistics available for this player.</p>
                    </div>
                  )}

                  <Spacing
                    id="stm-spacing-player-footer"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Footer Sponsors -->
    <div class="footer-sponsors" role="complementary" aria-label="Footer sponsors">
      <div class="sportspress">
        <div class="sp-sponsors"></div>
      </div>
    </div>
  </div>

  <Footer />

  <!-- Additional Scripts and Styles -->
  <div class="rev-close-btn" aria-hidden="true">
    <span class="close-left"></span>
    <span class="close-right"></span>
  </div>

  <!-- Speculation Rules for Prefetching -->
  <script is:inline type="speculationrules">
    {
      "prefetch": [
        {
          "source": "document",
          "where": {
            "and": [
              { "href_matches": "/*" },
              {
                "not": {
                  "href_matches": [
                    "/wp-*.php",
                    "/wp-admin/*",
                    "/wp-content/uploads/*",
                    "/wp-content/*",
                    "/wp-content/plugins/*",
                    "/wp-content/themes/elevate/*",
                    "/*\\?(.+)"
                  ]
                }
              },
              { "not": { "selector_matches": "a[rel~=\"nofollow\"]" } },
              { "not": { "selector_matches": ".no-prefetch, .no-prefetch a" } }
            ]
          },
          "eagerness": "conservative"
        }
      ]
    }
  </script>

  <!-- Header Sponsors -->
  <div class="sp-header-sponsors" style="margin-top: 10px; margin-right: 10px;" aria-hidden="true">
    <div class="sportspress"><div class="sp-sponsors"></div></div>
  </div>

  <!-- Legacy Scripts -->
  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header");
          var sponsors = $(".sp-header-sponsors");
          if (header.length && sponsors.length) {
            header.prepend(sponsors);
          }
        });
      }
    })();
  </script>

  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header-loaded");
          var menu = $(".sp-league-menu");
          if (header.length && menu.length) {
            header.prepend(menu);
          }
        });
      }
    })();
  </script>

  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header-loaded");
          var scoreboard = $(".sp-header-scoreboard");
          if (header.length && scoreboard.length) {
            header.prepend(scoreboard);
          }
        });
      }
    })();
  </script>

  <style>
    /* Player Detail Page Styles */
    .player-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .player-header-content {
      display: flex;
      align-items: flex-start;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .player-image-large {
      flex-shrink: 0;
      width: 200px;
      height: 200px;
      border-radius: 8px;
      overflow: hidden;
      background: #f8f9fa;
    }

    .player-image-large img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .player-image-large-placeholder {
      width: 200px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #dd3333 0%, #b82828 100%);
      border-radius: 8px;
    }

    .player-image-text-large {
      font-size: 72px;
      font-weight: 700;
      color: #fff;
      font-family: 'Teko', sans-serif;
    }

    .player-header-info {
      flex: 1;
      min-width: 250px;
    }

    .player-title {
      font-family: 'Teko', sans-serif;
      font-size: 48px;
      line-height: 52px;
      color: #dd3333;
      margin: 0 0 0.5rem 0;
      font-weight: 700;
      text-transform: uppercase;
    }

    .player-team {
      font-family: 'Rubik', sans-serif;
      font-size: 18px;
      line-height: 24px;
      color: #666;
      margin: 0 0 1rem 0;
    }

    .team-link {
      color: #dd3333;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }

    .team-link:hover {
      color: #b82828;
      text-decoration: underline;
    }

    .player-details {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .player-detail-item {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      line-height: 20px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .player-detail-item i {
      color: #dd3333;
      width: 16px;
    }

    .player-detail-item strong {
      color: #333;
      font-weight: 600;
    }

    .player-section {
      margin-bottom: 3rem;
    }

    .section-title {
      font-family: 'Teko', sans-serif;
      font-size: 32px;
      line-height: 36px;
      color: #dd3333;
      margin: 0 0 1.5rem 0;
      font-weight: 700;
      text-transform: uppercase;
    }

    .player-bio {
      font-family: 'Rubik', sans-serif;
      font-size: 16px;
      line-height: 24px;
      color: #666;
    }

    .player-bio p {
      margin: 0 0 1rem 0;
    }

    .player-bio p:last-child {
      margin-bottom: 0;
    }

    .player-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .stat-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      transition: border-color 0.3s ease, transform 0.3s ease;
    }

    .stat-card:hover {
      border-color: #dd3333;
      transform: translateY(-5px);
    }

    .stat-label {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      line-height: 20px;
      color: #666;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .stat-value {
      font-family: 'Teko', sans-serif;
      font-size: 36px;
      line-height: 40px;
      color: #dd3333;
      font-weight: 700;
    }

    .no-data-message {
      font-family: 'Rubik', sans-serif;
      font-size: 16px;
      color: #666;
      text-align: center;
      padding: 2rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .footer-sponsors {
      background: var(--color-gray-100, #f4f4f4);
      color: var(--color-gray-800, #363f48);
      padding: var(--spacing-6, 1.5rem) 0;
    }

    .footer-sponsors .sp-sponsors .sp-sponsors-title {
      color: var(--color-gray-800, #363f48);
    }

    /* Responsive Styles */
    @media (max-width: 991px) {
      .player-header-content {
        flex-direction: column;
        text-align: center;
      }

      .player-image-large,
      .player-image-large-placeholder {
        margin: 0 auto;
      }

      .player-title {
        font-size: 36px;
        line-height: 40px;
      }

      .section-title {
        font-size: 28px;
        line-height: 32px;
      }

      .player-stats-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
      }
    }

    @media (max-width: 767px) {
      .player-title {
        font-size: 28px;
        line-height: 32px;
      }

      .section-title {
        font-size: 24px;
        line-height: 28px;
      }

      .player-details {
        flex-direction: column;
        gap: 1rem;
      }

      .player-stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .stat-value {
        font-size: 28px;
        line-height: 32px;
      }
    }
  </style>
</Layout>


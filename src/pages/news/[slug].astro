---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import TopBar from '../../features/layout/components/TopBar.astro';
import Header from '../../features/layout/components/Header.astro';
import MobileMenu from '../../features/layout/components/MobileMenu';
import Footer from '../../features/layout/components/Footer.astro';
import { getNewsArticleBySlug, getNewsArticles } from '../../features/cms/lib/queries';
import { reverseCategoryMap } from '../../features/cms/types';
import CommentsList from '../../features/comments/components/CommentsList';
import { prisma } from '../../lib/prisma';
import NewsSidebar from '../../features/news/components/NewsSidebar.astro';
import NewsBreadcrumbs from '../../features/news/components/NewsBreadcrumbs.astro';

const { slug } = Astro.params;
if (!slug) {
  return Astro.redirect('/404', 302);
}

let article;
try {
  article = await getNewsArticleBySlug(slug);
  if (!article || !article.published) {
    return Astro.redirect('/404', 302);
  }
} catch (error) {
  console.error('Error fetching article:', error);
  return Astro.redirect('/404', 302);
}


const category = reverseCategoryMap[article.category] || article.category;
const publishedDate = article.publishedAt 
  ? new Date(article.publishedAt).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

const modifiedDate = article.updatedAt
  ? new Date(article.updatedAt).toISOString()
  : publishedDate
  ? new Date(article.publishedAt!).toISOString()
  : null;

// Get comment count
let commentCount = 0;
try {
  if (prisma.comment) {
    commentCount = await prisma.comment.count({
      where: {
        articleId: article.id,
        approved: true,
      },
    });
  }
} catch (error) {
  console.error('Error fetching comment count:', error);
}


const getCategoryColor = (cat: string): string => {
  const colors: Record<string, string> = {
    'Interviews': '#667eea',
    'Championships': '#f5576c',
    'Match report': '#4facfe',
    'Analysis': '#43e97b',
  };
  return colors[cat] || '#64748b';
};

const categoryColor = getCategoryColor(category);

// SEO Meta Tags
const pageTitle = `${article.title} - Elevate`;
const pageDescription = article.excerpt || article.title;
const pageUrl = `${Astro.url.origin}/news/${slug}`;
const pageImage = article.image || `${Astro.url.origin}/images/Elevate_Icon-200x200.png`;
const publishedTime = article.publishedAt ? new Date(article.publishedAt).toISOString() : null;
const modifiedTime = modifiedDate;
---

<Layout>
  <script is:inline define:vars={{ pageTitle, pageDescription, pageUrl, pageImage, publishedTime, modifiedTime, authorName: article.author.name, articleTitle: article.title }}>
      // Update page title
      document.title = pageTitle;
      
      // Update or create meta tags
      const updateMeta = (name, content, property = false) => {
        const attr = property ? 'property' : 'name';
        let meta = document.querySelector(`meta[${attr}="${name}"]`);
        if (!meta) {
          meta = document.createElement('meta');
          meta.setAttribute(attr, name);
          document.head.appendChild(meta);
        }
        meta.setAttribute('content', content);
      };
      
      // Update canonical link
      let canonical = document.querySelector('link[rel="canonical"]');
      if (!canonical) {
        canonical = document.createElement('link');
        canonical.setAttribute('rel', 'canonical');
        document.head.appendChild(canonical);
      }
      canonical.setAttribute('href', pageUrl);
      
      // Set meta tags
      updateMeta('og:locale', 'en_US', true);
      updateMeta('og:type', 'article', true);
      updateMeta('og:title', pageTitle, true);
      updateMeta('og:description', pageDescription, true);
      updateMeta('og:url', pageUrl, true);
      updateMeta('og:site_name', 'Elevate', true);
      if (publishedTime) updateMeta('article:published_time', publishedTime, true);
      if (modifiedTime) updateMeta('article:modified_time', modifiedTime, true);
      updateMeta('og:image', pageImage, true);
      updateMeta('author', authorName);
      updateMeta('twitter:card', 'summary_large_image');
      updateMeta('twitter:label1', 'Written by');
      updateMeta('twitter:data1', authorName);
      updateMeta('twitter:label2', 'Est. reading time');
      updateMeta('twitter:data2', '3 minutes');
    </script>
    
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "WebPage",
          "@id": pageUrl,
          "url": pageUrl,
          "name": pageTitle,
          "isPartOf": { "@id": `${Astro.url.origin}/#website` },
          "primaryImageOfPage": { "@id": `${pageUrl}#primaryimage` },
          "image": { "@id": `${pageUrl}#primaryimage` },
          "thumbnailUrl": pageImage,
          ...(publishedTime && { "datePublished": publishedTime }),
          ...(modifiedTime && { "dateModified": modifiedTime }),
          "author": {
            "@id": `${Astro.url.origin}/#/schema/person/${article.author.id}`,
            "name": article.author.name
          },
          "breadcrumb": { "@id": `${pageUrl}#breadcrumb` },
          "inLanguage": "en-US",
          "potentialAction": [{ "@type": "ReadAction", "target": [pageUrl] }]
        },
        {
          "@type": "ImageObject",
          "inLanguage": "en-US",
          "@id": `${pageUrl}#primaryimage`,
          "url": pageImage,
          "contentUrl": pageImage,
          ...(article.image && { "width": 2560, "height": 1707 })
        },
        {
          "@type": "BreadcrumbList",
          "@id": `${pageUrl}#breadcrumb`,
          "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": `${Astro.url.origin}/` },
            { "@type": "ListItem", "position": 2, "name": "News", "item": `${Astro.url.origin}/news/` },
            { "@type": "ListItem", "position": 3, "name": article.title }
          ]
        }
      ]
    })} />
  <div id="wrapper">
    <TopBar />
    <Header />
    <MobileMenu client:load />
    
    <main id="main" role="main">
      <!--SINGLE POST-->
      <div id={`post-${article.id}`} class={`post-${article.id} post type-post status-publish format-standard has-post-thumbnail hentry category-${article.category.toLowerCase()}`}>
        <div class="stm-single-post stm-default-page">
          <div class="container">
            <div class="row stm-format-">
              <!-- Main Content -->
              <div class="col-md-9 col-sm-12 col-xs-12">
                <div class="sidebar-margin-top clearfix"></div>
                
                <!-- Breadcrumbs -->
                <div class="stm-small-title-box">
                  <div class="stm-title-box-unit">
                    <NewsBreadcrumbs items={[
                      { label: 'Elevate', url: '/' },
                      { label: 'News', url: '/news/' },
                      { label: category, url: `/news?category=${category}` },
                      { label: article.title }
                    ]} />
                    
                    <!-- Page Title -->
                    <div class="stm-page-title">
        <div class="container">
                        <div class="clearfix stm-title-box-title-wrapper">
                          <h1 class="stm-main-title-unit">{article.title}</h1>
                        </div>
                      </div>
                    </div>
                </div>
              </div>

                <!-- Post Thumbnail -->
            {article.image && (
                  <div class="post-thumbnail">
                    <img 
                      fetchpriority="high" 
                      width="1170" 
                      height="650" 
                      src={article.image} 
                      class="img-responsive wp-post-image" 
                      alt={article.title} 
                      decoding="async"
                    />
              </div>
            )}

                <!-- Post Meta -->
                <div class="stm-single-post-meta clearfix normal_font">
                  <div class="stm-meta-left-part">
                    {publishedDate && (
                      <div class="stm-date">
                        <i class="fa fa-calendar-o"></i>
                        {publishedDate}
                      </div>
                    )}
                    <div class="stm-author">
                      <i class="fa fa-user"></i>
                      {article.author.name}
                    </div>
                  </div>

                  <div class="stm-comments-num">
                    <a href="#comments" class="stm-post-comments">
                      <i class="fa fa-commenting"></i>
                      {commentCount > 0 && <span>{commentCount}</span>}
                    </a>
                  </div>
                </div>

                <!-- Post Content -->
                <div class="post-content">
            <div class="article-body" set:html={article.content} />
                  <div class="clearfix"></div>
                </div>

                <!-- Post Meta Bottom -->
                <div class="stm-post-meta-bottom normal_font clearfix">
                  <div class="stm_post_tags"></div>
                </div>

                <!-- Comments -->
                <div class="stm_post_comments">
            <CommentsList client:load articleId={article.id} showForm={true} />
          </div>
        </div>

              <!-- Sidebar -->
              <div class="col-md-3 hidden-sm hidden-xs af-margin-88">
                <NewsSidebar searchQuery="" showTags={false} showInstagram={false} />
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer Sponsors -->
    <div class="footer-sponsors" role="complementary" aria-label="Footer sponsors">
      <div class="sportspress">
        <div class="sp-sponsors"></div>
      </div>
    </div>
  </div>

  <Footer />

  <style>
    /* WordPress-style single post layout */
    #main {
      padding-top: 2rem !important;
      padding-bottom: 200px; /* Space for fixed footer */
    }

    .stm-single-post {
      padding: 2rem 0;
      background: #ffffff;
    }

    /* Ensure footer is visible */
    .stm-footer {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 100 !important;
      display: block !important;
      visibility: visible !important;
    }


    .stm-page-title {
      margin-bottom: 2rem;
    }

    .stm-main-title-unit {
      font-family: 'Teko', sans-serif;
      font-size: 50px;
      line-height: 54px;
      color: #dd3333;
      margin: 0;
      font-weight: 700;
    }

    .post-thumbnail {
      width: 100%;
      margin: 2rem 0;
      overflow: hidden;
    }

    .post-thumbnail img {
      width: 100%;
      height: auto;
      display: block;
    }

    .stm-single-post-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2rem 0;
      padding: 1rem 0;
      border-top: 1px solid #e2e8f0;
      border-bottom: 1px solid #e2e8f0;
    }

    .stm-meta-left-part {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .stm-date,
    .stm-author {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 14px;
      color: #666;
    }

    .stm-date i,
    .stm-author i {
      color: #dd3333;
    }

    .stm-comments-num a {
      color: #666;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stm-comments-num a:hover {
      color: #dd3333;
    }

    .post-content {
      margin: 2rem 0;
    }

    .article-body {
      font-size: 16px;
      line-height: 1.8;
      color: #333;
      font-family: 'Rubik', sans-serif;
    }

    .article-body :global(p) {
      margin: 1.5rem 0;
    }

    .article-body :global(h1),
    .article-body :global(h2),
    .article-body :global(h3),
    .article-body :global(h4),
    .article-body :global(h5),
    .article-body :global(h6) {
      font-family: 'Teko', sans-serif;
      color: #dd3333;
      margin: 2rem 0 1rem 0;
      font-weight: 600;
    }

    .article-body :global(h3) {
      font-size: 25px;
      line-height: 29px;
    }

    .article-body :global(ul),
    .article-body :global(ol) {
      margin: 1.5rem 0;
      padding-left: 2rem;
    }

    .article-body :global(blockquote) {
      border-left: 4px solid #dd3333;
      padding-left: 1.5rem;
      margin: 2rem 0;
      color: #666;
      font-style: italic;
    }

    .article-body :global(img) {
      max-width: 100%;
      height: auto;
      margin: 2rem 0;
    }




    /* Comments Section */
    .stm_post_comments {
      margin-top: 3rem;
      padding-top: 3rem;
      border-top: 2px solid #e2e8f0;
    }

    .footer-sponsors {
      background: var(--color-gray-100, #f4f4f4);
      color: var(--color-gray-800, #363f48);
      padding: var(--spacing-6, 1.5rem) 0;
    }

    .footer-sponsors .sp-sponsors .sp-sponsors-title {
      color: var(--color-gray-800, #363f48);
    }

    /* Remove yellow background from reply buttons */
    .comment-reply-button,
    .view-replies-button,
    .comment-item button[type="button"],
    .comment-item .reply,
    .comment-item .comment-reply-link,
    .comment-replies button[type="button"],
    button.comment-reply-button,
    button.view-replies-button {
      background: transparent !important;
      background-color: transparent !important;
    }

    .comment-reply-button:hover,
    .view-replies-button:hover,
    .comment-item button[type="button"]:hover,
    .comment-item .reply:hover,
    .comment-item .comment-reply-link:hover,
    .comment-replies button[type="button"]:hover,
    button.comment-reply-button:hover,
    button.view-replies-button:hover {
      background: transparent !important;
      background-color: transparent !important;
    }

    /* Spinner Animation */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }


    @media (max-width: 768px) {
      .stm-main-title-unit {
        font-size: 32px;
        line-height: 36px;
      }

      .stm-single-post-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .stm-meta-left-part {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

    }
  </style>
</Layout>


---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import TopBar from '../features/layout/components/TopBar.astro';
import Header from '../features/layout/components/Header.astro';
import MobileMenu from '../features/layout/components/MobileMenu';
import Footer from '../features/layout/components/Footer.astro';
import { getTeamsPaginated } from '../features/cms/lib/queries';
import { resolveAssetUrl, getDisplayImageUrl } from '../lib/asset-url';
import Spacing from '../shared/components/ui/Spacing.astro';
import PageLoader from '../components/PageLoader';
import ContentLoader from '../components/ContentLoader';

const PER_PAGE = 12;
const pageParam = Astro.url.searchParams.get('page');
const currentPage = Math.max(1, parseInt(pageParam || '1', 10) || 1);
const searchQuery = Astro.url.searchParams.get('search') ?? '';

let teams: Awaited<ReturnType<typeof getTeamsPaginated>>['teams'] = [];
let totalCount = 0;
let totalPages = 1;
let currentPageRes = 1;
let hasError = false;
try {
  const result = await getTeamsPaginated(currentPage, PER_PAGE, false, searchQuery || undefined);
  teams = result.teams;
  totalCount = result.totalCount;
  totalPages = result.totalPages;
  currentPageRes = result.currentPage;
} catch (error) {
  console.error('Error fetching teams:', error);
  hasError = true;
}

function teamsPageUrl(page: number, search: string): string {
  const base = `${Astro.url.origin}/teams`;
  if (page <= 1 && !search) return `${base}/`;
  const params = new URLSearchParams();
  if (page > 1) params.set('page', String(page));
  if (search) params.set('search', search);
  return params.toString() ? `${base}?${params.toString()}` : `${base}/`;
}

// SEO Meta Tags (use clamped page from result)
const pageTitle = currentPageRes === 1 && !searchQuery
  ? 'Teams - Elevate Ballers'
  : searchQuery
    ? `Teams - "${searchQuery}" - Elevate Ballers`
    : `Teams - Page ${currentPageRes} - Elevate Ballers`;
const pageDescription = 'View all teams in the Elevate Ballers league';
const pageUrl = teamsPageUrl(currentPageRes, searchQuery);
const startItem = totalCount === 0 ? 0 : (currentPageRes - 1) * PER_PAGE + 1;
const endItem = Math.min(currentPageRes * PER_PAGE, totalCount);
---

<Layout>
  <script is:inline define:vars={{ pageTitle, pageDescription, pageUrl }}>
    // Update page title
    document.title = pageTitle;
    
    // Update or create meta tags
    const updateMeta = (name, content, property = false) => {
      const attr = property ? 'property' : 'name';
      let meta = document.querySelector(`meta[${attr}="${name}"]`);
      if (!meta) {
        meta = document.createElement('meta');
        meta.setAttribute(attr, name);
        document.head.appendChild(meta);
      }
      meta.setAttribute('content', content);
    };
    
    // Update canonical link
    let canonical = document.querySelector('link[rel="canonical"]');
    if (!canonical) {
      canonical = document.createElement('link');
      canonical.setAttribute('rel', 'canonical');
      document.head.appendChild(canonical);
    }
    canonical.setAttribute('href', pageUrl);
    
    // Set meta tags
    updateMeta('og:locale', 'en_US', true);
    updateMeta('og:type', 'website', true);
    updateMeta('og:title', pageTitle, true);
    updateMeta('og:description', pageDescription, true);
    updateMeta('og:url', pageUrl, true);
    updateMeta('og:site_name', 'Elevate Ballers', true);
    updateMeta('twitter:card', 'summary_large_image');
  </script>
  
  <script type="application/ld+json" is:inline set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebPage",
        "@id": pageUrl,
        "url": pageUrl,
        "name": pageTitle,
        "isPartOf": { "@id": `${Astro.url.origin}/#website` },
        "datePublished": "2016-04-19T05:29:11+00:00",
        "dateModified": new Date().toISOString(),
        "breadcrumb": { "@id": `${pageUrl}#breadcrumb` },
        "inLanguage": "en-US"
      },
      {
        "@type": "BreadcrumbList",
        "@id": `${pageUrl}#breadcrumb`,
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": `${Astro.url.origin}/` },
          { "@type": "ListItem", "position": 2, "name": "Teams" }
        ]
      }
    ]
  })} />
  
  <PageLoader client:load />
  <div id="wrapper">
    <TopBar />
    <Header />
    <MobileMenu client:load />
    <div id="main">
      <div
        class="stm-title-box-unit transparent-header_on title_box-357"
        style="padding-top: 0; padding-bottom: 0px;"
      ></div>
      <div class="container">
        <section class="wpb-content-wrapper">
          <div class="vc_row wpb_row vc_row-fluid">
            <div class="wpb_column vc_column_container vc_col-sm-12">
              <div class="vc_column-inner">
                <div class="wpb_wrapper">
                  <Spacing
                    id="stm-spacing-teams-header"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />

                  <h2 class="heading-font" style="text-align: center; margin-bottom: 50px; color: #dd3333;">
                    TEAMS
                  </h2>

                  <form class="teams-search-form" method="get" action="/teams">
                    <label for="teams-search-input" class="teams-search-label">Search teams</label>
                    <div class="teams-search-row">
                      <input
                        id="teams-search-input"
                        type="search"
                        name="search"
                        value={searchQuery}
                        placeholder="Search by name..."
                        class="teams-search-input"
                        aria-label="Search teams by name"
                      />
                      <button type="submit" class="teams-search-button">Search</button>
                      {searchQuery && (
                        <a href="/teams" class="teams-search-clear">Clear</a>
                      )}
                    </div>
                  </form>

                  {hasError ? (
                    <ContentLoader client:load message="Failed to load teams. Please try again later." />
                  ) : teams.length === 0 ? (
                    <div class="no-teams-message">
                      {searchQuery ? (
                        <p>No teams found for "{searchQuery}". <a href="/teams">Clear search</a></p>
                      ) : (
                        <p>No teams available at this time.</p>
                      )}
                    </div>
                  ) : (
                    <div class="teams-grid">
                      {teams.map((team) => (
                        <div class="team-card">
                          <a href={`/teams/${team.slug}`} class="team-card-link">
                            {resolveAssetUrl(team.logo) ? (
                              <div class="team-logo">
                                <img 
                                  src={getDisplayImageUrl(team.logo, Astro.url.origin)!} 
                                  alt={`${team.name} logo`}
                                />
                              </div>
                            ) : (
                              <div class="team-logo-placeholder">
                                <span class="team-logo-text">{team.name.charAt(0).toUpperCase()}</span>
                              </div>
                            )}
                            <div class="team-info">
                              <h3 class="team-name">{team.name}</h3>
                              <div class="team-stats">
                                <span class="team-player-count">
                                  <i class="fa fa-users" aria-hidden="true"></i>
                                  {team._count.players} {team._count.players === 1 ? 'Player' : 'Players'}
                                </span>
                              </div>
                            </div>
                          </a>
                        </div>
                      ))}
                    </div>
                  )}

                  {!hasError && totalCount > 0 && (
                    <div class="teams-pagination-wrapper">
                      <p class="teams-pagination-summary">
                        Showing {startItem}-{endItem} of {totalCount} teams
                      </p>
                      {totalPages > 1 && (
                        <nav class="teams-pagination" aria-label="Teams pagination">
                          <ul class="teams-pagination-list">
                            <li>
                              {currentPageRes > 1 ? (
                                <a class="teams-pagination-link" href={teamsPageUrl(currentPageRes - 1, searchQuery)} aria-label="Previous page">Previous</a>
                              ) : (
                                <span class="teams-pagination-link teams-pagination-link--disabled" aria-disabled="true">Previous</span>
                              )}
                            </li>
                            {Array.from({ length: totalPages }, (_, i) => i + 1).map((p) => (
                              <li>
                                {p === currentPageRes ? (
                                  <span class="teams-pagination-link teams-pagination-link--current" aria-current="page">{p}</span>
                                ) : (
                                  <a class="teams-pagination-link" href={teamsPageUrl(p, searchQuery)}>{p}</a>
                                )}
                              </li>
                            ))}
                            <li>
                              {currentPageRes < totalPages ? (
                                <a class="teams-pagination-link" href={teamsPageUrl(currentPageRes + 1, searchQuery)} aria-label="Next page">Next</a>
                              ) : (
                                <span class="teams-pagination-link teams-pagination-link--disabled" aria-disabled="true">Next</span>
                              )}
                            </li>
                          </ul>
                        </nav>
                      )}
                    </div>
                  )}

                  <Spacing
                    id="stm-spacing-teams-footer"
                    lg="50"
                    md="50"
                    sm="40"
                    xs="40"
                  />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <Footer />

  <div class="sp-footer-sponsors">
    <div class="sportspress"><div class="sp-sponsors"></div></div>
  </div>

  <!-- Additional Scripts and Styles -->
  <div class="rev-close-btn" aria-hidden="true">
    <span class="close-left"></span>
    <span class="close-right"></span>
  </div>

  <!-- Speculation Rules for Prefetching -->
  <script is:inline type="speculationrules">
    {
      "prefetch": [
        {
          "source": "document",
          "where": {
            "and": [
              { "href_matches": "/*" },
              {
                "not": {
                  "href_matches": [
                    "/wp-*.php",
                    "/wp-admin/*",
                    "/wp-content/uploads/*",
                    "/wp-content/*",
                    "/wp-content/plugins/*",
                    "/wp-content/themes/elevate/*",
                    "/*\\?(.+)"
                  ]
                }
              },
              { "not": { "selector_matches": "a[rel~=\"nofollow\"]" } },
              { "not": { "selector_matches": ".no-prefetch, .no-prefetch a" } }
            ]
          },
          "eagerness": "conservative"
        }
      ]
    }
  </script>

  <!-- Header Sponsors -->
  <div class="sp-header-sponsors" style="margin-top: 10px; margin-right: 10px;" aria-hidden="true">
    <div class="sportspress"><div class="sp-sponsors"></div></div>
  </div>

  <!-- Legacy Scripts -->
  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header");
          var sponsors = $(".sp-header-sponsors");
          if (header.length && sponsors.length) {
            header.prepend(sponsors);
          }
        });
      }
    })();
  </script>

  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header-loaded");
          var menu = $(".sp-league-menu");
          if (header.length && menu.length) {
            header.prepend(menu);
          }
        });
      }
    })();
  </script>

  <script is:inline type="text/javascript">
    (function() {
      if (typeof jQuery !== 'undefined') {
        jQuery(document).ready(function ($) {
          var header = $(".sp-header-loaded");
          var scoreboard = $(".sp-header-scoreboard");
          if (header.length && scoreboard.length) {
            header.prepend(scoreboard);
          }
        });
      }
    })();
  </script>

  <style>
    /* Teams Page Styles */
    .no-teams-message {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-family: 'Rubik', sans-serif;
      font-size: 16px;
    }

    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .team-card {
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .team-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .team-card-link {
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .team-logo {
      width: 100%;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      padding: 1.5rem;
      overflow: hidden;
    }

    .team-logo img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .team-logo-placeholder {
      width: 100%;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #dd3333 0%, #b82828 100%);
    }

    .team-logo-text {
      font-size: 72px;
      font-weight: 700;
      color: #fff;
      font-family: 'Teko', sans-serif;
    }

    .team-info {
      padding: 1.5rem;
    }

    .team-name {
      font-family: 'Teko', sans-serif;
      font-size: 24px;
      line-height: 28px;
      color: #dd3333;
      margin: 0 0 1rem 0;
      font-weight: 700;
      text-transform: uppercase;
    }

    .team-description {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      line-height: 20px;
      color: #666;
      margin: 0 0 1rem 0;
    }

    .team-stats {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    .team-player-count {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .team-player-count i {
      color: #dd3333;
    }

    .teams-pagination-wrapper {
      margin-top: 2.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .teams-pagination-summary {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      color: #666;
      margin: 0;
    }

    .teams-pagination-list {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .teams-pagination-link {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.25rem;
      height: 2.25rem;
      padding: 0 0.5rem;
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #dd3333;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      text-decoration: none;
      transition: background 0.2s, border-color 0.2s;
    }

    .teams-pagination-link:hover:not(.teams-pagination-link--disabled):not(.teams-pagination-link--current) {
      background: #f8f9fa;
      border-color: #dd3333;
    }

    .teams-pagination-link--current {
      background: #dd3333;
      border-color: #dd3333;
      color: #fff;
      cursor: default;
    }

    .teams-pagination-link--disabled {
      color: #9ca3af;
      cursor: not-allowed;
    }

    .teams-search-form {
      margin-bottom: 2rem;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }

    .teams-search-label {
      display: block;
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .teams-search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .teams-search-input {
      flex: 1;
      min-width: 180px;
      height: 2.5rem;
      padding: 0 0.75rem;
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      color: #374151;
    }

    .teams-search-input:focus {
      outline: none;
      border-color: #dd3333;
      box-shadow: 0 0 0 2px rgba(221, 51, 51, 0.2);
    }

    .teams-search-input::placeholder {
      color: #9ca3af;
    }

    .teams-search-button {
      height: 2.5rem;
      padding: 0 1rem;
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      background: #dd3333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .teams-search-button:hover {
      background: #b82828;
    }

    .teams-search-clear {
      font-family: 'Rubik', sans-serif;
      font-size: 14px;
      color: #dd3333;
      text-decoration: none;
    }

    .teams-search-clear:hover {
      text-decoration: underline;
    }

    /* Responsive Styles */
    @media (max-width: 991px) {
      .teams-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1.5rem;
      }
    }

    @media (max-width: 767px) {
      .teams-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .team-logo,
      .team-logo-placeholder {
        height: 180px;
      }

      .team-logo-text {
        font-size: 56px;
      }

      .team-name {
        font-size: 20px;
        line-height: 24px;
      }
    }

    /* Page title styling - matching players page */
    .wpb_wrapper h2.heading-font {
      font-size: 40px;
      line-height: 44px;
      margin-bottom: 50px;
      color: #dd3333 !important;
    }

    .sp-footer-sponsors {
      background: #f4f4f4;
      color: #363f48;
    }
    .sp-footer-sponsors .sp-sponsors .sp-sponsors-title {
      color: #363f48;
    }
  </style>
</Layout>

